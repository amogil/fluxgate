# Authentication

Fluxgate supports two types of authentication for client requests:

1. **Static API keys** - Simple string-based authentication
2. **JWT tokens** - Time-limited tokens with signature verification

Both authentication methods use the `Authorization` header with the Bearer scheme.

## Bearer Authentication Scheme

All authentication must use the `Bearer` authentication scheme:

```
Authorization: Bearer <api_key_or_jwt_token>
```

Requests with non-Bearer authentication schemes (e.g., `Token`, `Basic`, `Digest`) are rejected with HTTP 401.

## Authentication Order

The proxy checks authentication in the following order:

1. **Static API keys** (`api_keys.static`) - checked first for exact string match
2. **JWT tokens** (`api_keys.jwt`) - checked if token matches JWT format (three parts separated by dots)

This ensures static keys are validated quickly, and JWT validation (which is more expensive) only occurs when the token is not a static key.

## Static API Key Authentication

Static API keys are simple string values that clients must present in the `Authorization` header.

### Configuration

Static API keys are configured in the `api_keys.static` section:

```yaml
api_keys:
  static:
    - id: pr
      key: 2qqwZ2MrffFMBguNMGVr
      upstreams:
        - openai-1
        - anthropic-1
    - id: marketing
      key: K1Rm67rX9vokI9sh555I
      upstreams:
        - anthropic-1
```

### Parameters

- **`id`** (optional): Human-readable label for the API key (used in logs for observability)
- **`key`** (required): API key value that clients must present via Authorization header (must be non-empty and unique)
- **`upstreams`** (optional): List of upstream identifiers this key may access. When empty or omitted, the API key has access to all configured upstreams

### Access Control

- If `upstreams` is specified and non-empty, the API key has access only to the listed upstreams
- If `upstreams` is empty or omitted, the API key has access to all configured upstreams
- If `upstreams` is empty and no upstreams are configured, requests with this API key are rejected with HTTP 401

### Usage

Clients send static API keys in the `Authorization` header:

```bash
curl -H "Authorization: Bearer 2qqwZ2MrffFMBguNMGVr" \
  http://localhost:8080/openai/v1/models
```

## JWT Token Authentication

JWT (JSON Web Token) authentication provides time-limited access and can be dynamically generated by your authentication service.

### JWT Token Requirements

JWT tokens must meet the following requirements:

- **Format:** Three base64url-encoded parts separated by dots: `header.payload.signature`
- **Algorithm:** Must use `HS256` (HMAC-SHA256) for signature verification
- **Type:** Header must contain `typ: "JWT"`
- **Key ID:** Header must contain `kid` (key identifier) that matches one of the `id` values in `api_keys.jwt` configuration
- **Expiration:** Optional `exp` claim (Unix timestamp in seconds) - if present, token must not be expired
- **Not Before:** Optional `nbf` claim (Unix timestamp in seconds) - if present, current time must be >= nbf

### Configuration

JWT API keys are configured in the `api_keys.jwt` section:

```yaml
api_keys:
  jwt:
    - id: dev
      key: "REPLACE_WITH_JWT_SECRET_KEY"
    - id: test
      key: "REPLACE_WITH_JWT_SECRET_KEY"
```

### Parameters

- **`id`** (required): Human-readable label for the JWT API key (must be non-empty and unique across all JWT API keys). This must match the `kid` field in the JWT token header.
- **`key`** (required): JWT secret key value used for verifying JWT token signatures (must be non-empty string; may be duplicated across different JWT entries)

### Creating JWT Tokens

JWT tokens must be signed using the secret key (`key`) from the matching `api_keys.jwt` entry. The `kid` in the token header must match the `id` of the JWT key configuration entry.

Example JWT token structure:

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT",
    "kid": "dev"
  },
  "payload": {
    "exp": 1735689600,
    "nbf": 1735603200
  }
}
```

### Using JWT Tokens

Clients send JWT tokens in the `Authorization` header using the Bearer scheme:

```bash
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImRldiJ9..." \
  http://localhost:8080/openai/v1/models
```

### JWT Token Access Control

JWT tokens have access to **all configured upstreams** (similar to static API keys with empty or omitted `upstreams`). If no upstreams are configured, requests with valid JWT tokens are rejected with HTTP 401.

### JWT Token Validation

The proxy validates JWT tokens by:

1. Parsing the token into header, payload, and signature parts
2. Verifying the `alg` field is `HS256`
3. Verifying the `typ` field is `JWT`
4. Verifying the `kid` field matches a configured JWT key `id`
5. Verifying the signature using the matching secret key
6. Checking expiration (`exp`) if present
7. Checking not-before (`nbf`) if present

If any validation step fails, the request is rejected with HTTP 401.

## Authentication Failures

The proxy rejects requests with HTTP 401 in the following cases:

- Missing `Authorization` header
- Non-Bearer authentication scheme
- Static API key not found in `api_keys.static`
- JWT token format invalid (not three parts separated by dots)
- JWT token validation fails (invalid signature, wrong algorithm, expired, etc.)
- API key's `upstreams` list is empty and no upstreams are configured
- API key refers to no permitted upstreams

## Request Routing After Authentication

After successful authentication, the proxy:

1. Resolves the target upstream based on the request path matching the `request_path` parameter
2. Replaces the outbound `Authorization` header with the upstream's configured API key
3. Forwards the request to the selected upstream
4. Streams the upstream response back to the client

If no upstream matches the request path, the proxy rejects the request with HTTP 404 (Not Found).

